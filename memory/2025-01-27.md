# 2025-01-27 工作日志

## 🔧 400 错误自动恢复机制调研

### 问题背景
- Claude API 返回 400 错误（上下文溢出）时，agent 实例直接死掉
- Agent 自己不知道自己"死了"，无法自救
- 目前唯一恢复方法是用户手动执行 `/resume`
- 需要实现透明的自动恢复，无需用户干预

### 技术约束
- 使用中转站 API，非直接 Claude API
- 400 错误不可预测，无法预防
- 恢复必须在 OpenClaw gateway 层实现（因为 agent 已死）

### 调研进展

**Claude Code 分析（受阻）**
- 路径: `/home/jinyang/.nvm/versions/node/v22.22.0/lib/node_modules/@anthropic-ai/claude-code/`
- 主文件: `cli.js` (11MB, 严重混淆)
- 找到关键函数: `TQ1` (token counting), compact/microcompact 引用
- grep 结果: `/tmp/claude_code_error_handling.txt`
- **问题**: 代码混淆导致无法有效分析

### 下一步计划

1. **放弃 Claude Code 逆向**，直接在 OpenClaw 层实现
2. 定位 OpenClaw 源码的 API 错误处理逻辑
3. 实现自动恢复流程:
   ```
   检测 400 错误 → 自动执行 /resume → 重发用户消息
   ```

### 设计思路

```
用户消息 → OpenClaw Gateway → Claude API
                ↓
           400 Error?
                ↓ Yes
         自动 /resume (压缩上下文)
                ↓
         重发原始消息
                ↓
           返回响应
```

### 关键文件（待查找）
- OpenClaw 源码中的 API 调用逻辑
- 错误处理中间件
- `/resume` 命令实现

---

## 备注
- 这是 jinyang 优先关注的问题，影响日常使用体验
- 需要找到 OpenClaw 的源码位置才能继续
